<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solutions Team Dashboard</title>
    
    <!-- Fonts: Inter for that clean Yoco look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            500: '#3b82f6', // Yoco Blue-ish
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        [v-cloak] { display: none; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .scroll-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Subtle fade animation for list items */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden font-sans selection:bg-brand-500 selection:text-white">

<div id="app" v-cloak class="h-full flex flex-col">

    <!-- TOP NAVIGATION with Gradient Theme -->
    <header class="bg-gradient-to-r from-blue-700 to-cyan-500 h-16 flex items-center justify-between px-6 shrink-0 z-10 shadow-md">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-white/20 backdrop-blur-sm rounded-lg flex items-center justify-center text-white border border-white/10 shadow-sm">
                    <i class="ph-bold ph-ticket"></i>
                </div>
                <h1 class="font-bold text-lg tracking-tight text-white mr-4">Solutions Desk</h1>
            </div>

            <!-- Main Navigation Tabs -->
            <nav class="flex space-x-1">
                <button @click="currentView = 'tickets'" 
                    class="px-4 py-1.5 rounded-full text-sm font-medium transition-all"
                    :class="currentView === 'tickets' ? 'bg-white text-brand-600 shadow-sm' : 'text-blue-100 hover:bg-white/10'">
                    Help Desk
                </button>
                <button @click="switchView('analytics')" 
                    class="px-4 py-1.5 rounded-full text-sm font-medium transition-all"
                    :class="currentView === 'analytics' ? 'bg-white text-brand-600 shadow-sm' : 'text-blue-100 hover:bg-white/10'">
                    Analytics
                </button>
            </nav>
        </div>

        <div class="flex items-center gap-3">
            <span v-if="currentView === 'tickets'" class="bg-white/20 backdrop-blur text-white text-xs px-2.5 py-0.5 rounded-full font-medium border border-white/10 mr-2">{{ tickets.length }} Tickets</span>

            <!-- Agent Name Input -->
            <div class="hidden md:flex items-center bg-white/10 rounded-lg px-3 py-1 border border-white/10">
                <i class="ph-bold ph-user text-blue-100 mr-2 text-xs"></i>
                <input v-model="agentName" type="text" class="bg-transparent border-none text-white text-sm focus:ring-0 w-24 placeholder-blue-200" placeholder="Your Name">
            </div>

            <div class="h-6 w-px bg-white/20 mx-1"></div>

            <!-- Export Data Button -->
            <button @click="exportCSV" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-blue-50 hover:bg-white/10 rounded-lg transition-colors">
                <i class="ph ph-download-simple"></i>
                Export
            </button>
            
            <button @click="fetchTickets" class="p-2 text-blue-50 hover:bg-white/10 rounded-lg transition-colors" title="Refresh">
                <i class="ph-bold ph-arrows-clockwise" :class="{'animate-spin': loading}"></i>
            </button>
        </div>
    </header>

    <!-- VIEW: TICKETS (HELP DESK) -->
    <main v-if="currentView === 'tickets'" class="flex-1 flex overflow-hidden">
        
        <!-- LEFT: TICKET LIST -->
        <div class="w-1/3 min-w-[350px] max-w-[500px] border-r border-slate-200 flex flex-col bg-white">
            
            <!-- Filters -->
            <div class="p-4 border-b border-slate-100 flex gap-2 overflow-x-auto scroll-hide bg-slate-50/50">
                <button @click="filterStatus = 'All'" 
                    class="px-4 py-1.5 text-xs font-semibold rounded-full border transition-all whitespace-nowrap shadow-sm"
                    :class="filterStatus === 'All' ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300 hover:shadow'">
                    All
                </button>
                <button @click="filterStatus = 'Open'" 
                    class="px-4 py-1.5 text-xs font-semibold rounded-full border transition-all whitespace-nowrap shadow-sm"
                    :class="filterStatus === 'Open' ? 'bg-green-600 text-white border-green-600' : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300 hover:shadow'">
                    Open
                </button>
                <button @click="filterStatus = 'In Progress'" 
                    class="px-4 py-1.5 text-xs font-semibold rounded-full border transition-all whitespace-nowrap shadow-sm"
                    :class="filterStatus === 'In Progress' ? 'bg-brand-600 text-white border-brand-600' : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300 hover:shadow'">
                    In Progress
                </button>
                <button @click="filterStatus = 'Resolved'" 
                    class="px-4 py-1.5 text-xs font-semibold rounded-full border transition-all whitespace-nowrap shadow-sm"
                    :class="filterStatus === 'Resolved' ? 'bg-slate-600 text-white border-slate-600' : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300 hover:shadow'">
                    Resolved
                </button>
            </div>

            <!-- List -->
            <div class="flex-1 overflow-y-auto p-3 space-y-3 bg-slate-50">
                <div v-for="ticket in filteredTickets" :key="ticket.id" 
                     @click="selectTicket(ticket)"
                     class="p-4 rounded-xl border cursor-pointer transition-all duration-200 group relative"
                     :class="selectedTicket?.id === ticket.id ? 'bg-white border-brand-500 shadow-md ring-1 ring-brand-500 z-10 scale-[1.02]' : 'bg-white border-slate-200 hover:border-brand-300 hover:shadow-sm'">
                    
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-7 h-7 rounded-full bg-gradient-to-br from-slate-100 to-slate-200 text-slate-600 text-xs flex items-center justify-center font-bold border border-slate-200">
                                {{ getSmartSender(ticket).charAt(0).toUpperCase() }}
                            </div>
                            <span class="text-sm font-semibold text-slate-800 truncate max-w-[150px]">{{ getSmartSender(ticket) }}</span>
                        </div>
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded-md border" 
                              :class="getStatusColor(ticket.status)">
                            {{ ticket.status }}
                        </span>
                    </div>
                    
                    <p class="text-slate-600 text-sm line-clamp-2 leading-relaxed mb-3 font-mono text-xs bg-slate-50 p-1 rounded">{{ getSmartSummary(ticket.message) }}</p>
                    
                    <div class="flex items-center gap-2 mt-auto">
                        <!-- Client Badge -->
                        <span v-if="ticket.client_name || getSmartClient(ticket.message)" class="flex items-center gap-1 text-[10px] bg-indigo-50 text-indigo-700 px-2 py-1 rounded border border-indigo-100 font-medium">
                            <i class="ph-bold ph-buildings"></i> {{ ticket.client_name || getSmartClient(ticket.message) }}
                        </span>
                        <!-- Reply Count Badge -->
                        <span v-if="ticket.replies && ticket.replies.length > 0" class="flex items-center gap-1 text-[10px] bg-slate-100 text-slate-600 px-2 py-1 rounded border border-slate-200 font-medium">
                            <i class="ph-bold ph-chat-circle-dots"></i> {{ ticket.replies.length }}
                        </span>
                        <!-- Date -->
                        <span class="text-[10px] text-slate-400 ml-auto font-medium">{{ formatDate(ticket.created_at) }}</span>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div v-if="filteredTickets.length === 0 && !loading" class="text-center py-20 px-6 opacity-60">
                    <div class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400">
                        <i class="ph-duotone ph-inbox text-3xl"></i>
                    </div>
                    <p class="text-slate-500 font-medium">No tickets found</p>
                    <p class="text-xs text-slate-400 mt-1">Try adjusting your filters</p>
                </div>

                <div v-if="loading" class="text-center py-20">
                     <i class="ph-bold ph-spinner animate-spin text-2xl text-brand-600"></i>
                </div>
            </div>
        </div>

        <!-- RIGHT: DETAIL & EDIT PANEL -->
        <div class="flex-1 bg-slate-50/50 flex flex-col h-full overflow-hidden relative">
            
            <div v-if="selectedTicket" class="h-full flex flex-col">
                
                <!-- Ticket Header -->
                <div class="bg-white border-b border-slate-200 px-8 py-6 flex justify-between items-start shrink-0 shadow-sm z-10">
                    <div>
                        <div class="flex items-center gap-3 mb-1">
                            <h2 class="text-xl font-bold text-slate-900">Ticket #{{ selectedTicket.id }}</h2>
                             <span class="text-[10px] uppercase tracking-wider font-bold px-2 py-0.5 rounded border" 
                              :class="getStatusColor(selectedTicket.status)">
                                {{ selectedTicket.status }}
                            </span>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-slate-500">
                            <i class="ph-fill ph-slack-logo"></i>
                            <span>Slack Channel</span>
                            <span class="text-slate-300">•</span>
                            <span>{{ formatDateFull(selectedTicket.created_at) }}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                         <a v-if="selectedTicket.slack_ts" 
                           :href="`https://slack.com/archives/${selectedTicket.slack_channel}/p${selectedTicket.slack_ts.replace('.','')}`" 
                           target="_blank"
                           class="flex items-center gap-2 px-4 py-2 text-xs font-bold text-slate-700 bg-white hover:bg-slate-50 rounded-lg border border-slate-200 transition-colors shadow-sm">
                            Open in Slack <i class="ph-bold ph-arrow-up-right"></i>
                        </a>
                        <!-- DELETE BUTTON -->
                        <button @click="deleteTicket" class="flex items-center gap-2 px-4 py-2 text-xs font-bold text-red-600 bg-red-50 hover:bg-red-100 rounded-lg border border-red-200 transition-colors shadow-sm" title="Delete Ticket">
                            <i class="ph-bold ph-trash"></i>
                        </button>
                    </div>
                </div>

                <!-- Scrollable Content -->
                <div class="flex-1 overflow-y-auto p-8">
                    <div class="max-w-3xl mx-auto space-y-8">
                        
                        <!-- Original Message -->
                        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                            <div class="flex items-center gap-4 mb-5 pb-5 border-b border-slate-50">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-brand-500 to-cyan-400 text-white flex items-center justify-center font-bold text-xl shadow-md ring-2 ring-white">
                                    {{ getSmartSender(selectedTicket).charAt(0).toUpperCase() }}
                                </div>
                                <div>
                                    <div class="font-bold text-slate-900 text-lg">{{ getSmartSender(selectedTicket) }}</div>
                                    <div class="text-xs font-medium text-brand-600 bg-brand-50 inline-block px-2 py-0.5 rounded mt-0.5">Original Request</div>
                                </div>
                            </div>
                            <!-- Display message with whitespace preserved -->
                            <div class="text-slate-700 leading-relaxed whitespace-pre-wrap text-base font-mono bg-slate-50 p-4 rounded-lg border border-slate-100 text-sm">
                                {{ selectedTicket.message }}
                            </div>
                        </div>

                        <!-- Thread / Conversation History -->
                        <div v-if="selectedTicket.replies && selectedTicket.replies.length > 0" class="space-y-4">
                            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wide mb-4">Conversation History</h3>
                            
                            <div v-for="reply in selectedTicket.replies" :key="reply.id" class="flex gap-4" 
                                 :class="{'flex-row-reverse': isAgentReply(reply)}">
                                
                                <!-- Avatar -->
                                <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-xs shadow-sm border border-white"
                                     :class="isAgentReply(reply) ? 'bg-slate-800 text-white' : 'bg-slate-200 text-slate-600'">
                                    {{ (reply.sender || '?').charAt(0).toUpperCase() }}
                                </div>

                                <!-- Bubble -->
                                <div class="max-w-[80%] rounded-2xl p-4 text-sm shadow-sm border"
                                     :class="isAgentReply(reply) ? 'bg-slate-800 text-white border-slate-700 rounded-tr-none' : 'bg-white text-slate-700 border-slate-200 rounded-tl-none'">
                                    <div class="flex justify-between items-center mb-1 gap-4 opacity-80 text-xs">
                                        <span class="font-bold">{{ reply.sender }}</span>
                                        <span>{{ formatDateFull(reply.created_at) }}</span>
                                    </div>
                                    <p class="whitespace-pre-wrap leading-relaxed">{{ reply.message }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Data & Classification Form -->
                        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                            <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2 text-sm uppercase tracking-wide">
                                <i class="ph-duotone ph-sliders text-brand-600 text-lg"></i> Classification Details
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <!-- Status -->
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Status</label>
                                    <div class="relative">
                                        <select v-model="form.status" class="w-full appearance-none bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-medium focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-shadow">
                                            <option value="Open">Open</option>
                                            <option value="In Progress">In Progress</option>
                                            <option value="Resolved">Resolved</option>
                                        </select>
                                        <i class="ph-bold ph-caret-down absolute right-4 top-3.5 text-slate-400 pointer-events-none"></i>
                                    </div>
                                </div>

                                <!-- Issue Category -->
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Issue Type</label>
                                    <div class="relative">
                                        <select v-model="form.issue_category" class="w-full appearance-none bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-medium focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-shadow">
                                            <option value="">-- Select Category --</option>
                                            <option value="Bug">Bug Report</option>
                                            <option value="Feature Request">Feature Request</option>
                                            <option value="Access/Permissions">Access/Permissions</option>
                                            <option value="Question">General Question</option>
                                            <option value="Data Issue">Data Discrepancy</option>
                                        </select>
                                        <i class="ph-bold ph-caret-down absolute right-4 top-3.5 text-slate-400 pointer-events-none"></i>
                                    </div>
                                </div>

                                <!-- Client Name -->
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Client / Customer</label>
                                    <div class="relative">
                                        <i class="ph-bold ph-buildings absolute left-4 top-3.5 text-slate-400"></i>
                                        <input v-model="form.client_name" type="text" placeholder="e.g. Acme Corp" 
                                            class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-shadow">
                                    </div>
                                </div>

                                <!-- Internal Notes -->
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Internal Notes</label>
                                    <textarea v-model="form.notes" rows="3" placeholder="Add confidential notes for the solutions team..." 
                                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none resize-none transition-shadow"></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end pt-2 border-t border-slate-100 mt-4">
                                <button @click="saveChanges" :disabled="saving" 
                                    class="bg-brand-600 hover:bg-brand-700 text-white px-8 py-2.5 rounded-xl text-sm font-bold transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:shadow-none flex items-center gap-2 transform active:scale-95">
                                    <i v-if="saving" class="ph-bold ph-spinner animate-spin"></i>
                                    {{ saving ? 'Saving Changes...' : 'Save Updates' }}
                                </button>
                            </div>
                        </div>

                        <!-- Reply Box (Functional) -->
                        <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-2xl p-6 border border-slate-200 border-dashed text-center">
                            <h3 class="text-sm font-bold text-slate-700 mb-2">Reply to Slack</h3>
                            <p v-if="!isWebhookConfigured" class="text-xs text-red-500 mb-4 bg-red-50 p-2 rounded border border-red-100">⚠️ Please configure the ZAPIER_WEBHOOK_URL in the code to enable this.</p>
                            <p v-else class="text-xs text-slate-500 mb-4">This will post a reply to the original Slack thread.</p>
                             
                            <div :class="{'opacity-50 pointer-events-none': !isWebhookConfigured}">
                                <textarea v-model="replyText" class="w-full p-3 text-sm border rounded-lg bg-white mb-3 focus:ring-2 focus:ring-brand-500 outline-none" rows="3" placeholder="Write your reply here..."></textarea>
                                <button @click="sendReply" :disabled="sendingReply || !replyText" 
                                    class="bg-slate-800 text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-slate-900 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 mx-auto transition-colors">
                                    <i v-if="sendingReply" class="ph-bold ph-spinner animate-spin"></i>
                                    {{ sendingReply ? 'Sending...' : 'Send Reply to Slack' }}
                                </button>
                             </div>
                        </div>

                    </div>
                </div>

            </div>

            <!-- Nothing Selected State -->
            <div v-else class="h-full flex flex-col items-center justify-center text-slate-400 bg-slate-50/50">
                <div class="w-24 h-24 bg-white rounded-full shadow-sm flex items-center justify-center mb-6">
                    <i class="ph-duotone ph-cursor-click text-5xl text-brand-200"></i>
                </div>
                <h3 class="font-bold text-xl text-slate-700 mb-2">No Ticket Selected</h3>
                <p class="text-sm text-slate-500 max-w-xs text-center">Select a ticket from the list on the left to view details, classify issues, or send replies.</p>
            </div>
        </div>
    </main>

    <!-- VIEW: ANALYTICS -->
    <main v-if="currentView === 'analytics'" class="flex-1 overflow-y-auto bg-slate-50 p-8">
        <div class="max-w-6xl mx-auto">
            
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Analytics Overview</h2>
                    <p class="text-slate-500">Insights from your support tickets.</p>
                </div>
                <div class="text-sm text-slate-500 bg-white px-3 py-1 rounded border border-slate-200">
                    Last updated: Just now
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-slate-500 uppercase tracking-wide">Total Tickets</p>
                            <h3 class="text-3xl font-bold text-slate-800 mt-2">{{ stats.total }}</h3>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-blue-50 text-brand-600 flex items-center justify-center">
                            <i class="ph-bold ph-ticket text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-slate-500 uppercase tracking-wide">Open Backlog</p>
                            <h3 class="text-3xl font-bold text-slate-800 mt-2">{{ stats.open }}</h3>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center">
                            <i class="ph-bold ph-tray text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-slate-500 uppercase tracking-wide">Resolved</p>
                            <h3 class="text-3xl font-bold text-slate-800 mt-2">{{ stats.resolved }}</h3>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center">
                            <i class="ph-bold ph-check-circle text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Breakdown by Issue Type -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-6">Tickets by Issue Type</h3>
                    <div class="h-64 relative">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <!-- Top Requesters -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-6">Top Requesters</h3>
                    <div class="h-64 relative">
                        <canvas id="requesterChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Client Distribution -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-6">Tickets by Client</h3>
                    <div class="h-64 relative">
                        <canvas id="clientChart"></canvas>
                    </div>
                </div>

                <!-- Status Distribution -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-6">Current Status Breakdown</h3>
                    <div class="h-64 relative">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>

        </div>
    </main>

</div>

<script>
    const { createClient } = supabase;

    // CONFIGURATION: 
    const SUPABASE_URL = 'https://dloeemdnthbuggjdgcqr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsb2VlbWRudGhidWdnamRnY3FyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5ODM5NjcsImV4cCI6MjA4NjU1OTk2N30.lx-rCwbkxHEsb4CX6M6NORHDauL1qpraaFKIIpHvvig';
    
    // ZAPIER HOOK
    const ZAPIER_WEBHOOK_URL = 'https://hooks.zapier.com/hooks/catch/21408403/uex0g0l/'; 

    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            const currentView = ref('tickets'); 
            const tickets = ref([]); 
            const agentName = ref('Solutions Team'); // Default Name
            const searchQuery = ref('');
            const filterStatus = ref('All');
            const selectedTicket = ref(null);
            const loading = ref(false);
            const saving = ref(false);
            const sendingReply = ref(false);
            const replyText = ref('');
            
            // Stats Object
            const stats = ref({ total: 0, open: 0, resolved: 0 });

            // Chart Instances
            let categoryChartInstance = null;
            let requesterChartInstance = null;
            let clientChartInstance = null;
            let statusChartInstance = null;

            // Check if user has configured webhook
            const isWebhookConfigured = computed(() => ZAPIER_WEBHOOK_URL && ZAPIER_WEBHOOK_URL.length > 5);

            // Form State
            const form = ref({
                status: 'Open',
                issue_category: '',
                client_name: '',
                notes: ''
            });

            // 1. Fetch Tickets & GROUP THEM
            const fetchTickets = async () => {
                loading.value = true;
                const { data, error } = await sb
                    .from('tickets')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error:', error);
                } else {
                    const allRows = data || [];
                    
                    // 1. Separate Parents (Tickets) from Children (Replies)
                    // If thread_ts is missing or empty, treat as parent.
                    // Also check for user's explicit request to hide bot spam loops.
                    const parents = [];
                    const repliesMap = {};

                    allRows.forEach(row => {
                        // Cleanup logic: Hide infinite loop bot messages
                        const msg = (row.message || '').toLowerCase();
                        if (msg.includes('regarding your request') && msg.includes('ticket id')) return;

                        if (row.thread_ts) {
                            // It's a reply
                            if (!repliesMap[row.thread_ts]) repliesMap[row.thread_ts] = [];
                            repliesMap[row.thread_ts].push(row);
                        } else {
                            // It's a main ticket
                            parents.push(row);
                        }
                    });

                    // 2. Attach replies to parents
                    parents.forEach(p => {
                        // Sort replies by date ascending (oldest first)
                        const relatedReplies = repliesMap[p.slack_ts] || [];
                        p.replies = relatedReplies.sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
                    });

                    tickets.value = parents;
                    
                    calculateStats();
                    if (currentView.value === 'analytics') {
                        nextTick(() => renderCharts());
                    }
                }
                loading.value = false;
            };

            // Switch View Logic
            const switchView = (view) => {
                currentView.value = view;
                if (view === 'analytics') {
                    // Wait for DOM update so canvas exists
                    nextTick(() => {
                        renderCharts();
                    });
                }
            };

            // Calculate Basic Stats
            const calculateStats = () => {
                const total = tickets.value.length;
                const open = tickets.value.filter(t => t.status !== 'Resolved').length;
                const resolved = tickets.value.filter(t => t.status === 'Resolved').length;
                stats.value = { total, open, resolved };
            };

            // Helper: Normalize text
            const normalizeText = (text) => {
                if (!text) return 'Unknown';
                // Remove leading @ and format
                return text.trim().replace(/^@/, '')
                    .toLowerCase()
                    .replace(/\s+/g, ' ')
                    .split(' ')
                    .map(w => w.charAt(0).toUpperCase() + w.slice(1))
                    .join(' ');
            };

            // Render Charts
            const renderCharts = () => {
                const data = tickets.value;
                const countBy = (arr, keyFn) => {
                    const counts = {};
                    arr.forEach(item => { const key = keyFn(item) || 'Unknown'; counts[key] = (counts[key] || 0) + 1; });
                    return counts;
                };

                const catCounts = countBy(data, t => {
                    if (t.issue_category) return t.issue_category;
                    const msg = (t.message || '').toLowerCase();
                    if (msg.includes('bug')) return 'Bug';
                    if (msg.includes('feature')) return 'Feature Request';
                    return 'Unclassified';
                });

                if (categoryChartInstance) categoryChartInstance.destroy();
                categoryChartInstance = new Chart(document.getElementById('categoryChart'), {
                    type: 'doughnut',
                    data: { labels: Object.keys(catCounts), datasets: [{ data: Object.values(catCounts), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1'] }] },
                    options: { maintainAspectRatio: false }
                });

                const senderCounts = countBy(data, t => normalizeText(getSmartSender(t)));
                const sortedSenders = Object.entries(senderCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);
                
                if (requesterChartInstance) requesterChartInstance.destroy();
                requesterChartInstance = new Chart(document.getElementById('requesterChart'), {
                    type: 'bar',
                    data: { labels: sortedSenders.map(i => i[0]), datasets: [{ label: 'Tickets', data: sortedSenders.map(i => i[1]), backgroundColor: '#8b5cf6' }] },
                    options: { indexAxis: 'y', maintainAspectRatio: false }
                });

                const clientCounts = countBy(data, t => normalizeText(t.client_name || getSmartClient(t.message)));
                const sortedClients = Object.entries(clientCounts).filter(x => x[0] !== 'Unknown').sort((a,b) => b[1] - a[1]).slice(0, 5);

                if (clientChartInstance) clientChartInstance.destroy();
                clientChartInstance = new Chart(document.getElementById('clientChart'), {
                    type: 'bar',
                    data: { labels: sortedClients.map(i => i[0]), datasets: [{ label: 'Tickets', data: sortedClients.map(i => i[1]), backgroundColor: '#0ea5e9' }] },
                    options: { maintainAspectRatio: false }
                });

                const statusCounts = countBy(data, t => t.status || 'Open');
                if (statusChartInstance) statusChartInstance.destroy();
                statusChartInstance = new Chart(document.getElementById('statusChart'), {
                    type: 'bar',
                    data: { labels: Object.keys(statusCounts), datasets: [{ label: 'Count', data: Object.values(statusCounts), backgroundColor: ['#22c55e', '#3b82f6', '#64748b'] }] },
                    options: { maintainAspectRatio: false }
                });
            };

            const filteredTickets = computed(() => {
                return tickets.value.filter(t => {
                    const matchesSearch = (t.sender || '').toLowerCase().includes(searchQuery.value.toLowerCase()) || 
                                          (t.client_name || '').toLowerCase().includes(searchQuery.value.toLowerCase()) ||
                                          (t.message || '').toLowerCase().includes(searchQuery.value.toLowerCase());
                    const matchesStatus = filterStatus.value === 'All' || t.status === filterStatus.value;
                    return matchesSearch && matchesStatus;
                });
            });

            // Cleanup: No longer needed for infinite loops as we filter them on load, but nice to keep
            const cleanupBotReplies = async (allTickets) => {
                // Logic moved to fetchTickets for performance
            };

            const getSmartSender = (ticket) => {
                let name = 'Unknown';
                if (ticket.message) {
                    const match = ticket.message.match(/(?:Ticket logged by):\s*(.+?)(?:\n|$)/i);
                    if (match) name = match[1].trim();
                    else name = ticket.sender || 'Unknown';
                } else {
                    name = ticket.sender || 'Unknown';
                }
                // Remove leading @
                return name.replace(/^@/, '');
            };

            const getSmartClient = (message) => {
                if (!message) return '';
                const match = message.match(/(?:Client|Client Name):\s*(.+?)(?:\n|$)/i);
                return match ? match[1].trim() : '';
            };

            const getSmartSummary = (message) => {
                if (!message) return 'No details provided';
                const match = message.match(/(?:Details):\s*(.+)(?:\n|$)/i);
                if (match) return match[1].trim().substring(0, 100);
                return message.substring(0, 100);
            };

            const isAgentReply = (reply) => {
                // If it was logged by us, or has no smart-parsed sender from Slack
                return (reply.sender === agentName.value) || (reply.sender === 'Solutions Team');
            };

            const selectTicket = (ticket) => {
                selectedTicket.value = ticket;
                replyText.value = ''; 
                
                let client = ticket.client_name || '';
                let category = ticket.issue_category || '';

                if (ticket.message) {
                    if (!client) {
                        const clientMatch = ticket.message.match(/(?:Client|Client Name):\s*(.+?)(?:\n|$)/i);
                        if (clientMatch) client = clientMatch[1].trim();
                    }
                    if (!category) {
                        const issueMatch = ticket.message.match(/(?:Issue Type|Issue):\s*(.+?)(?:\n|$)/i);
                        if (issueMatch) {
                            const rawIssue = issueMatch[1].trim();
                            if (rawIssue.toLowerCase().includes('bug')) category = 'Bug';
                            else if (rawIssue.toLowerCase().includes('feature')) category = 'Feature Request';
                            else category = 'Question'; 
                        }
                    }
                }

                form.value = {
                    status: ticket.status || 'Open',
                    issue_category: category,
                    client_name: client,
                    notes: ticket.notes || ''
                };
            };

            const saveChanges = async () => {
                if (!selectedTicket.value) return;
                saving.value = true;
                const { error } = await sb.from('tickets').update({
                    status: form.value.status,
                    issue_category: form.value.issue_category,
                    client_name: form.value.client_name,
                    notes: form.value.notes
                }).eq('id', selectedTicket.value.id);

                if (error) alert('Error saving to Supabase.');
                else {
                    Object.assign(selectedTicket.value, form.value);
                    calculateStats();
                }
                saving.value = false;
            };
            
            const deleteTicket = async () => {
                if (!selectedTicket.value) return;
                if (!confirm('Are you sure you want to delete this ticket?')) return;
                const { error } = await sb.from('tickets').delete().eq('id', selectedTicket.value.id);
                if (error) alert('Error deleting ticket.');
                else {
                    tickets.value = tickets.value.filter(t => t.id !== selectedTicket.value.id);
                    selectedTicket.value = null;
                    calculateStats();
                }
            };

            // SEND REPLY & LOG TO DB
            const sendReply = async () => {
                if (!replyText.value || !selectedTicket.value) return;
                sendingReply.value = true;

                try {
                    // 1. Send to Slack (Zapier)
                    await fetch(ZAPIER_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            reply_text: replyText.value,
                            slack_ts: selectedTicket.value.slack_ts,
                            slack_channel: selectedTicket.value.slack_channel,
                            ticket_id: selectedTicket.value.id,
                            sender: getSmartSender(selectedTicket.value)
                        })
                    });

                    // 2. Log to Supabase (so it shows in history)
                    // We try to insert `thread_ts` here. If column doesn't exist, this might fail silently or error depending on config.
                    // User MUST run the SQL for this to work perfectly.
                    const { data, error } = await sb.from('tickets').insert({
                        message: replyText.value,
                        sender: agentName.value,
                        slack_ts: Date.now().toString(), // Dummy ID for sorting
                        thread_ts: selectedTicket.value.slack_ts, // LINK TO PARENT
                        status: 'Replied',
                        slack_channel: selectedTicket.value.slack_channel
                    }).select();

                    alert('Reply sent!');
                    replyText.value = '';
                    
                    // Optimistic update: Add to local view
                    if (data && data.length > 0) {
                        if (!selectedTicket.value.replies) selectedTicket.value.replies = [];
                        selectedTicket.value.replies.push(data[0]);
                    }

                    if (form.value.status === 'Open') {
                        form.value.status = 'In Progress';
                        saveChanges();
                    }

                } catch (e) {
                    console.error('Error:', e);
                    alert('Error sending reply. Check console.');
                } finally {
                    sendingReply.value = false;
                }
            };

            const exportCSV = () => {
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "ID,Date,Sender,Client,Issue Category,Status,Message,Notes\n";
                tickets.value.forEach(row => {
                    const date = new Date(row.created_at).toLocaleDateString();
                    const sender = getSmartSender(row); 
                    const cleanMsg = (row.message || '').replace(/"/g, '""').replace(/,/g, ';').replace(/\n/g, ' '); 
                    const cleanNotes = (row.notes || '').replace(/"/g, '""').replace(/,/g, ';').replace(/\n/g, ' ');
                    csvContent += `${row.id},${date},${sender},${row.client_name},${row.issue_category},${row.status},"${cleanMsg}","${cleanNotes}"\n`;
                });
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "solutions_desk_export.csv");
                document.body.appendChild(link);
                link.click();
            };

            // Helpers
            const formatDate = (dateString) => new Date(dateString).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            const formatDateFull = (dateString) => new Date(dateString).toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
            const getStatusColor = (status) => {
                switch(status) {
                    case 'Open': return 'bg-green-100 text-green-700 border-green-200';
                    case 'In Progress': return 'bg-blue-100 text-blue-700 border-blue-200';
                    case 'Resolved': return 'bg-slate-100 text-slate-600 border-slate-200';
                    default: return 'bg-gray-100 text-gray-600';
                }
            };

            onMounted(() => {
                fetchTickets();
                sb.channel('custom-all-channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'tickets' }, () => {
                    fetchTickets(); 
                })
                .subscribe();
            });

            return { 
                currentView, switchView, stats, agentName,
                tickets, filteredTickets, selectedTicket, form, loading, saving, searchQuery, filterStatus,
                replyText, sendingReply, isWebhookConfigured,
                fetchTickets, selectTicket, saveChanges, deleteTicket, sendReply, exportCSV, formatDate, formatDateFull, getStatusColor,
                getSmartSender, getSmartClient, getSmartSummary, isAgentReply
            };
        }
    }).mount('#app');
</script>

</body>
</html>
