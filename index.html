<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solutions Team Dashboard</title>
    <!-- Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js (Logic) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        [v-cloak] { display: none; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .scroll-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden">

<div id="app" v-cloak class="h-full flex flex-col">

    <!-- TOP NAVIGATION -->
    <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 shrink-0 z-10">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                <i class="ph-bold ph-ticket"></i>
            </div>
            <h1 class="font-bold text-lg tracking-tight">Solutions Desk</h1>
            <span class="bg-slate-100 text-slate-500 text-xs px-2 py-1 rounded-full font-medium">{{ tickets.length }} Tickets</span>
        </div>

        <div class="flex items-center gap-3">
            <!-- Search -->
            <div class="relative group">
                <i class="ph ph-magnifying-glass absolute left-3 top-2.5 text-slate-400 group-focus-within:text-blue-500"></i>
                <input v-model="searchQuery" type="text" placeholder="Search sender, client..." 
                    class="pl-9 pr-4 py-2 bg-slate-100 border-transparent border rounded-lg text-sm focus:bg-white focus:border-blue-500 focus:ring-0 transition-all w-64">
            </div>

            <div class="h-6 w-px bg-slate-200 mx-1"></div>

            <!-- Export Data Button -->
            <button @click="exportCSV" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors">
                <i class="ph ph-download-simple"></i>
                Export CSV
            </button>
            
            <button @click="fetchTickets" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Refresh">
                <i class="ph-bold ph-arrows-clockwise" :class="{'animate-spin': loading}"></i>
            </button>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- LEFT: TICKET LIST -->
        <div class="w-1/3 min-w-[350px] max-w-[500px] border-r border-slate-200 flex flex-col bg-white">
            
            <!-- Filters -->
            <div class="p-4 border-b border-slate-100 flex gap-2 overflow-x-auto scroll-hide">
                <button @click="filterStatus = 'All'" 
                    class="px-3 py-1.5 text-xs font-medium rounded-full border transition-colors whitespace-nowrap"
                    :class="filterStatus === 'All' ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300'">
                    All
                </button>
                <button @click="filterStatus = 'Open'" 
                    class="px-3 py-1.5 text-xs font-medium rounded-full border transition-colors whitespace-nowrap"
                    :class="filterStatus === 'Open' ? 'bg-green-600 text-white border-green-600' : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300'">
                    Open
                </button>
                <button @click="filterStatus = 'In Progress'" 
                    class="px-3 py-1.5 text-xs font-medium rounded-full border transition-colors whitespace-nowrap"
                    :class="filterStatus === 'In Progress' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300'">
                    In Progress
                </button>
                <button @click="filterStatus = 'Resolved'" 
                    class="px-3 py-1.5 text-xs font-medium rounded-full border transition-colors whitespace-nowrap"
                    :class="filterStatus === 'Resolved' ? 'bg-slate-600 text-white border-slate-600' : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300'">
                    Resolved
                </button>
            </div>

            <!-- List -->
            <div class="flex-1 overflow-y-auto p-2 space-y-2 bg-slate-50">
                <div v-for="ticket in filteredTickets" :key="ticket.id" 
                     @click="selectTicket(ticket)"
                     class="p-4 rounded-xl border cursor-pointer transition-all hover:shadow-md group relative"
                     :class="selectedTicket?.id === ticket.id ? 'bg-white border-blue-500 ring-1 ring-blue-500 shadow-sm' : 'bg-white border-slate-200 hover:border-blue-300'">
                    
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 text-white text-xs flex items-center justify-center font-bold">
                                {{ ticket.sender ? ticket.sender.charAt(0).toUpperCase() : '?' }}
                            </div>
                            <span class="text-sm font-semibold text-slate-700 truncate max-w-[150px]">{{ ticket.sender || 'Unknown' }}</span>
                        </div>
                        <span class="text-[10px] font-medium px-2 py-0.5 rounded border" 
                              :class="getStatusColor(ticket.status)">
                            {{ ticket.status }}
                        </span>
                    </div>
                    
                    <p class="text-slate-600 text-sm line-clamp-2 leading-relaxed mb-3">{{ ticket.message }}</p>
                    
                    <div class="flex items-center gap-2">
                        <!-- Client Badge -->
                        <span v-if="ticket.client_name" class="flex items-center gap-1 text-[10px] bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded border border-slate-200">
                            <i class="ph-bold ph-buildings"></i> {{ ticket.client_name }}
                        </span>
                        <!-- Date -->
                        <span class="text-[10px] text-slate-400 ml-auto">{{ formatDate(ticket.created_at) }}</span>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div v-if="filteredTickets.length === 0" class="text-center py-12 px-6">
                    <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-400">
                        <i class="ph-duotone ph-inbox text-2xl"></i>
                    </div>
                    <p class="text-slate-500 text-sm">No tickets found.</p>
                </div>
            </div>
        </div>

        <!-- RIGHT: DETAIL & EDIT PANEL -->
        <div class="flex-1 bg-slate-50 flex flex-col h-full overflow-hidden relative">
            
            <div v-if="selectedTicket" class="h-full flex flex-col">
                
                <!-- Ticket Header -->
                <div class="bg-white border-b border-slate-200 p-6 flex justify-between items-start shrink-0">
                    <div>
                        <h2 class="text-lg font-bold text-slate-800 mb-1">Ticket #{{ selectedTicket.id }}</h2>
                        <div class="flex items-center gap-2 text-sm text-slate-500">
                            <span>via Slack</span>
                            <span>•</span>
                            <span>{{ formatDateFull(selectedTicket.created_at) }}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                         <a v-if="selectedTicket.slack_ts" 
                           :href="`https://slack.com/archives/${selectedTicket.slack_channel}/p${selectedTicket.slack_ts.replace('.','')}`" 
                           target="_blank"
                           class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded border border-slate-200 transition-colors">
                            Open in Slack ↗
                        </a>
                    </div>
                </div>

                <!-- Scrollable Content -->
                <div class="flex-1 overflow-y-auto p-6 md:p-8">
                    <div class="max-w-3xl mx-auto space-y-6">
                        
                        <!-- The Message -->
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                            <div class="flex items-center gap-3 mb-4 pb-4 border-b border-slate-100">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 text-white flex items-center justify-center font-bold text-lg shadow-sm">
                                    {{ selectedTicket.sender ? selectedTicket.sender.charAt(0).toUpperCase() : '?' }}
                                </div>
                                <div>
                                    <div class="font-semibold text-slate-800">{{ selectedTicket.sender }}</div>
                                    <div class="text-xs text-slate-500">Requester</div>
                                </div>
                            </div>
                            <p class="text-slate-700 leading-relaxed whitespace-pre-wrap">{{ selectedTicket.message }}</p>
                        </div>

                        <!-- Data & Classification Form -->
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                            <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                                <i class="ph-duotone ph-tag text-blue-500"></i> Classification
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <!-- Status -->
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1 uppercase tracking-wide">Status</label>
                                    <select v-model="form.status" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                        <option value="Open">Open</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Resolved">Resolved</option>
                                    </select>
                                </div>

                                <!-- Issue Category -->
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1 uppercase tracking-wide">Issue Type</label>
                                    <select v-model="form.issue_category" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                        <option value="">-- Select Category --</option>
                                        <option value="Bug">Bug Report</option>
                                        <option value="Feature Request">Feature Request</option>
                                        <option value="Access/Permissions">Access/Permissions</option>
                                        <option value="Question">General Question</option>
                                        <option value="Data Issue">Data Discrepancy</option>
                                    </select>
                                </div>

                                <!-- Client Name -->
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-medium text-slate-500 mb-1 uppercase tracking-wide">Client / Customer</label>
                                    <div class="relative">
                                        <i class="ph-bold ph-buildings absolute left-3 top-2.5 text-slate-400"></i>
                                        <input v-model="form.client_name" type="text" placeholder="e.g. Acme Corp" 
                                            class="w-full pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                    </div>
                                </div>

                                <!-- Internal Notes -->
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-medium text-slate-500 mb-1 uppercase tracking-wide">Internal Notes</label>
                                    <textarea v-model="form.notes" rows="3" placeholder="Add details for the team..." 
                                        class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none"></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end pt-2">
                                <button @click="saveChanges" :disabled="saving" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm disabled:opacity-50 flex items-center gap-2">
                                    <i v-if="saving" class="ph-bold ph-spinner animate-spin"></i>
                                    {{ saving ? 'Saving...' : 'Save Changes' }}
                                </button>
                            </div>
                        </div>

                        <!-- Reply Box (Placeholder for now) -->
                        <div class="bg-slate-100 rounded-xl p-6 border border-slate-200 border-dashed text-center">
                            <h3 class="text-sm font-semibold text-slate-600 mb-2">Reply to Slack</h3>
                            <p class="text-xs text-slate-500 mb-4">Once Zapier is connected, you can reply directly from here.</p>
                             <textarea disabled class="w-full p-3 text-sm border rounded bg-white mb-2 cursor-not-allowed" rows="2" placeholder="Reply functionality coming soon..."></textarea>
                             <button disabled class="bg-slate-300 text-white px-4 py-2 rounded text-sm font-medium cursor-not-allowed">Send Reply</button>
                        </div>

                    </div>
                </div>

            </div>

            <!-- Nothing Selected State -->
            <div v-else class="h-full flex flex-col items-center justify-center text-slate-400">
                <i class="ph-duotone ph-cursor-click text-6xl mb-4 text-slate-300"></i>
                <p class="font-medium text-lg text-slate-500">Select a ticket to view details</p>
                <p class="text-sm">Manage metadata, status, and client info.</p>
            </div>

        </div>
    </main>
</div>

<script>
    const { createClient } = supabase;

    // TODO: REPLACE WITH YOUR SUPABASE KEYS
    const SUPABASE_URL = 'https://dloeemdnthbuggjdgcqr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsb2VlbWRudGhidWdnamRnY3FyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5ODM5NjcsImV4cCI6MjA4NjU1OTk2N30.lx-rCwbkxHEsb4CX6M6NORHDauL1qpraaFKIIpHvvig';

    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            const tickets = ref([]);
            const searchQuery = ref('');
            const filterStatus = ref('All');
            const selectedTicket = ref(null);
            const loading = ref(false);
            const saving = ref(false);

            // Form State
            const form = ref({
                status: 'Open',
                issue_category: '',
                client_name: '',
                notes: ''
            });

            // 1. Fetch Tickets
            const fetchTickets = async () => {
                loading.value = true;
                const { data, error } = await sb
                    .from('tickets')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error:', error);
                    alert('Error connecting to DB. Check console/keys.');
                } else {
                    tickets.value = data;
                }
                loading.value = false;
            };

            // 2. Filter Logic
            const filteredTickets = computed(() => {
                return tickets.value.filter(t => {
                    const matchesSearch = (t.sender || '').toLowerCase().includes(searchQuery.value.toLowerCase()) || 
                                          (t.client_name || '').toLowerCase().includes(searchQuery.value.toLowerCase()) ||
                                          (t.message || '').toLowerCase().includes(searchQuery.value.toLowerCase());
                    
                    const matchesStatus = filterStatus.value === 'All' || t.status === filterStatus.value;
                    
                    return matchesSearch && matchesStatus;
                });
            });

            // 3. Selection Logic
            const selectTicket = (ticket) => {
                selectedTicket.value = ticket;
                // Copy values to form for editing
                form.value = {
                    status: ticket.status || 'Open',
                    issue_category: ticket.issue_category || '',
                    client_name: ticket.client_name || '',
                    notes: ticket.notes || ''
                };
            };

            // 4. Save Changes to DB
            const saveChanges = async () => {
                if (!selectedTicket.value) return;
                saving.value = true;

                const { error } = await sb
                    .from('tickets')
                    .update({
                        status: form.value.status,
                        issue_category: form.value.issue_category,
                        client_name: form.value.client_name,
                        notes: form.value.notes
                    })
                    .eq('id', selectedTicket.value.id);

                if (error) {
                    alert('Error saving');
                } else {
                    // Update local state immediately
                    Object.assign(selectedTicket.value, form.value);
                }
                saving.value = false;
            };

            // 5. Helper: Export CSV
            const exportCSV = () => {
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "ID,Date,Sender,Client,Issue Category,Status,Message,Notes\n";

                tickets.value.forEach(row => {
                    const date = new Date(row.created_at).toLocaleDateString();
                    // Escape commas in message
                    const cleanMsg = (row.message || '').replace(/"/g, '""').replace(/,/g, ';'); 
                    const cleanNotes = (row.notes || '').replace(/"/g, '""').replace(/,/g, ';');
                    
                    csvContent += `${row.id},${date},${row.sender},${row.client_name},${row.issue_category},${row.status},"${cleanMsg}","${cleanNotes}"\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "solutions_data_export.csv");
                document.body.appendChild(link);
                link.click();
            };

            // Helpers
            const formatDate = (dateString) => {
                const d = new Date(dateString);
                return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            };
            
            const formatDateFull = (dateString) => {
                return new Date(dateString).toLocaleString();
            };

            const getStatusColor = (status) => {
                switch(status) {
                    case 'Open': return 'bg-green-100 text-green-700 border-green-200';
                    case 'In Progress': return 'bg-blue-100 text-blue-700 border-blue-200';
                    case 'Resolved': return 'bg-slate-100 text-slate-600 border-slate-200';
                    default: return 'bg-gray-100 text-gray-600';
                }
            };

            // Init
            onMounted(() => {
                // If user hasn't set keys, don't crash, just log
                if (SUPABASE_URL.includes('YOUR')) {
                    console.log('Waiting for Supabase Keys...');
                    // Mock data for display purposes if no keys
                    tickets.value = [
                        { id: 101, created_at: new Date().toISOString(), sender: 'Alice Smith', message: 'I cannot access the new dashboard feature.', status: 'Open', client_name: 'TechFlow', issue_category: 'Bug' },
                        { id: 102, created_at: new Date().toISOString(), sender: 'Bob Jones', message: 'How do I reset my API key?', status: 'In Progress', client_name: 'LogistiCorp', issue_category: 'Question' },
                        { id: 103, created_at: new Date().toISOString(), sender: 'Charlie Day', message: 'System is throwing 500 errors on login.', status: 'Resolved', client_name: '', issue_category: '' }
                    ];
                } else {
                    fetchTickets();
                    
                    // Realtime Listener
                    sb.channel('custom-all-channel')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'tickets' }, (payload) => {
                        fetchTickets(); // Refresh list on any change
                    })
                    .subscribe();
                }
            });

            return { 
                tickets, filteredTickets, selectedTicket, form, loading, saving, searchQuery, filterStatus,
                fetchTickets, selectTicket, saveChanges, exportCSV, formatDate, formatDateFull, getStatusColor 
            };
        }
    }).mount('#app');
</script>

</body>
</html>
